blueprint:
  name: ESPSomfy Vertical Blinds Controller (Percentage-Based)
  description: >
    Control system for ESPSomfy vertical blinds with automatic timing calculation.
    Only requires measuring ONE timing - the full travel time from open to closed.
    
    Send any percentage value (1-100) to move blinds to that position.
    Uses smart timing calculation with soft start compensation.
    
    Perfect for Benthin IQ2 motors with soft start/stop.
  
  domain: automation
  input:
    blind_entity:
      name: Blind Entity
      description: The ESPSomfy cover entity to control
      selector:
        entity:
          domain: cover
    
    blind_id:
      name: Blind ID
      description: >
        Unique identifier for this blind (e.g., "dining", "lounge", "bedroom").
        Used to target events to this specific blind.
      selector:
        text:
    
    position_tracker:
      name: Position Tracker Entity
      description: >
        Input number helper to track current position percentage.
        Create with min: 1, max: 100, step: 1
      selector:
        entity:
          domain: input_number
    
    # Single timing measurement - everything else is calculated!
    full_travel_time:
      name: Full Travel Time (ms)
      description: >
        Time it takes to go from fully open (position 3) to fully closed (position 1).
        This is the ONLY timing you need to measure!
      default: 30000
      selector:
        number:
          min: 5000
          max: 120000
          step: 100
          unit_of_measurement: "ms"
    
    soft_start_compensation:
      name: Soft Start Compensation (ms)
      description: >
        Extra time added to calculated movements to compensate for motor soft start/stop.
        Increase if blinds don't reach target positions.
      default: 1000
      selector:
        number:
          min: 0
          max: 5000
          step: 100
          unit_of_measurement: "ms"
    
    reset_buffer:
      name: Reset Buffer Time (ms)
      description: Extra time added when resetting to ensure fully open position
      default: 3000
      selector:
        number:
          min: 1000
          max: 10000
          step: 500
          unit_of_measurement: "ms"
    
    reset_first:
      name: Always Reset Position First
      description: >
        Always go to fully open position before moving to target.
        Enable this if timing drift is a problem.
      default: false
      selector:
        boolean:

trigger:
  - platform: event
    event_type: vertical_blinds_move

variables:
  blind_id: !input blind_id
  position_tracker: !input position_tracker
  current_position: "{{ states(position_tracker) | float }}"
  target_position: "{{ trigger.event.data.position | float }}"
  reset_first: !input reset_first
  reset_buffer: !input reset_buffer
  
  # Timing inputs
  full_travel: !input full_travel_time
  soft_comp: !input soft_start_compensation
  
  # Calculate movement time dynamically based on positions
  # Formula: time = (full_travel Ã— distance_percentage) + soft_compensation
  # distance_percentage = abs(target - current) / 100
  calculate_time: >
    {% set distance_pct = ((target_position - current_position) | abs) / 100.0 %}
    {% if distance_pct >= 0.99 %}
      {{ full_travel | int }}
    {% else %}
      {{ ((full_travel | float) * distance_pct + (soft_comp | float)) | int }}
    {% endif %}
  
  # Determine movement direction (100 = open, 1 = closed)
  movement_direction: >
    {% if target_position > current_position %}Up{% else %}Down{% endif %}

condition:
  - condition: template
    value_template: "{{ trigger.event.data.blind_id == blind_id }}"

action:
  # Optional: Reset to known position first (go to position 3 - fully open)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ reset_first }}"
        sequence:
          - choose:
              # Reset to fully open from any position
              - conditions:
                  - condition: template
                    value_template: "{{ current_position < 100 }}"
                sequence:
                  - service: espsomfy_rts.send_command
                    data:
                      entity_id: !input blind_entity
                      command: "Up"
                  - delay:
                      milliseconds: >
                        {% set distance_pct = (100 - current_position) / 100.0 %}
                        {{ ((full_travel | float) * distance_pct + (soft_comp | float) + (reset_buffer | float)) | int }}
          
          - service: input_number.set_value
            data:
              entity_id: !input position_tracker
              value: 100
          - variables:
              current_position: 100
  
  # Main movement logic - simplified with dynamic calculation
  - condition: template
    value_template: "{{ current_position != target_position }}"
  
  # Movement needed - calculate and execute
  - service: espsomfy_rts.send_command
    data:
      entity_id: !input blind_entity
      command: "{{ movement_direction }}"
  - delay:
      milliseconds: "{{ calculate_time }}"
  - service: espsomfy_rts.send_command
    data:
      entity_id: !input blind_entity
      command: "My"
  
  # Update position tracker after movement
  - service: input_number.set_value
    data:
      entity_id: !input position_tracker
      value: "{{ target_position }}"

mode: single
max_exceeded: silent